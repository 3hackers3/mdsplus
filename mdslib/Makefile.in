include @top_srcdir@/Makefile.inc

LIBS=@GLOBUS_LIBS@ @LIBS@ @LIBSOCKET@ @LIBNSL@ @LIBRESOLV@ @LIBM@
MDSLIB_LIBS=-lTdiShr -lTreeShr -lMdsShr

ifeq "@MDSIP_CONNECTIONS@" "yes"
MdsIpUtil="MdsIpShr"
else
MdsIpUtil="MdsIpUtil"
endif

SOURCES = MdsLib.c
OBJECTS = $(SOURCES:.c=.o) 
EXPORTS = MdsLib.export

OBJECTS_CLIENT = MdsLib_client.o 

all: @MAKEBINDIR@ @MAKELIBDIR@ \
         @MAKESHLIBDIR@libMdsLib_client@SHARETYPE@ \
         @MAKESHLIBDIR@libMdsLib@SHARETYPE@ \
         @MAKELIBDIR@libMdsLib_client.a \
         @MAKELIBDIR@libMdsLib.a @MAKEBINDIR@mdslib_ctest  \
         @MAKEBINDIR@mdslib_ftest  @MAKEBINDIR@mdslib_fremotetest \
	 @MAKEBINDIR@dtype_test

depend:
	@makedepend -- $(CFLAGS) -- $(SOURCES)

clean:
	@ $(RM) $(OBJECTS) $(OBJECTS_CLIENT) mdslib_ftest.o
	@ $(RM) @MAKELIBDIR@libMdsLib.a @MAKELIBDIR@libMdsLib_client.a
	@ $(RM) @MAKESHLIBDIR@libMdsLib@SHARETYPE@ @MAKESHLIBDIR@libMdsLib_client@SHARETYPE@
	@ $(RM) @MAKEBINDIR@dtype_test @MAKEBINDIR@mdslib_*test

install:
	$(MKDIR_P) @libdir@
	$(INSTALL) -m 644  @MAKELIBDIR@libMdsLib.a @MAKELIBDIR@libMdsLib_client.a @libdir@
	$(INSTALL) -m 755  @MAKESHLIBDIR@libMdsLib@SHARETYPE@ @MAKESHLIBDIR@libMdsLib_client@SHARETYPE@ @libdir@

@MAKELIBDIR@ @MAKEBINDIR@:
	$(MKDIR_P) $@

@MAKESHLIBDIR@libMdsLib@SHARETYPE@ : $(OBJECTS)
	$(LD) -o $@ @LINKSHARED@ $(LDFLAGS) $^ -L@MAKELIBDIR@ -l$(MdsIpUtil) -L@MAKESHLIBDIR@ $(MDSLIB_LIBS) $(LIBS) @MEMCHKLIB@ $(GLOBUS_LDFLAGS) $(GLOBUS_LIBS) $(GLOBUS_PKG_LIBS)

@MAKELIBDIR@libMdsLib.a : $(OBJECTS)
	$(AR) -cr $@ $^
	@RANLIB@ $@

@MAKESHLIBDIR@libMdsLib_client@SHARETYPE@ : $(OBJECTS_CLIENT)
	$(LD) -o $@ @LINKSHARED@ $(LDFLAGS) $^ -L@MAKELIBDIR@ -l$(MdsIpUtil) $(LIBS) @MEMCHKLIB@  $(GLOBUS_LDFLAGS) $(GLOBUS_LIBS) $(GLOBUS_PKG_LIBS)

@MAKELIBDIR@libMdsLib_client.a : $(OBJECTS_CLIENT) 
	$(AR) -cr $@ $^

MdsLib_client.o : MdsLib.c
	$(CC) -o $@ -c $(CFLAGS) $^ -D_CLIENT_ONLY

@MAKEBINDIR@mdslib_ctest : mdslib_ctest.c
	$(CC) -o $@ $(CFLAGS) @CC_LDFLAGS@ $^ -L@MAKESHLIBDIR@ -lMdsLib -lMdsIpShr $(MDSLIB_LIBS) $(LIBS) @LIBM@ $(GLOBUS_LDFLAGS) $(GLOBUS_LIBS) $(GLOBUS_PKG_LIBS)

@MAKEBINDIR@mdslib_ftest : mdslib_ftest.f
	$(LINK.F) $(OUTPUT_OPTION) $^ @FEXECLIBDIR@@MAKESHLIBDIR@ -lMdsLib -lMdsIpShr $(MDSLIB_LIBS) $(LIBS) $(GLOBUS_LDFLAGS) $(GLOBUS_LIBS) $(GLOBUS_PKG_LIBS)

@MAKEBINDIR@mdslib_fremotetest : mdslib_fremotetest.f
	$(LINK.F) $(OUTPUT_OPTION) $^ @FEXECLIBDIR@@MAKESHLIBDIR@ -lMdsLib -lMdsIpShr $(MDSLIB_LIBS) $(LIBS) $(GLOBUS_LDFLAGS) $(GLOBUS_LIBS) $(GLOBUS_PKG_LIBS)

@MAKEBINDIR@dtype_test : dtype_test.c
	$(CC) -o $@ $(CFLAGS) @CC_LDFLAGS@ $^ -L@MAKESHLIBDIR@ -lMdsLib -lMdsIpShr $(MDSLIB_LIBS) $(LIBS) $(GLOBUS_LDFLAGS) $(GLOBUS_LIBS) $(GLOBUS_PKG_LIBS)


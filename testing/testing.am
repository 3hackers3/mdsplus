
# //////////////////////////////////////////////////////////////////////////// #
# ///  TESTS SECTION   /////////////////////////////////////////////////////// #
# //////////////////////////////////////////////////////////////////////////// #
# //////////////////////////////////////////////////////////////////////////// #


TEST_CFLAGS = -I${top_srcdir}/testing
TEST_LIBS =  -lMdsTestShr @LIBM@ @THREAD@ @LIBRT@




# ///  select test form env variable  //////////////////////////////////////// #

TEST_BUILDTYPE = local


.PHONY: tap xml log
tap: $(TEST_SUITE_TAP)
xml: $(TEST_SUITE_XML)
log: $(TEST_SUITE_LOG)

tests:
	echo "Making tests ... "
	if [ -z ${TEST_FORMAT} ] ; then
	 $(MAKE) $(AM_MAKEFLAGS) tap;
	else
	 $(MAKE) $(AM_MAKEFLAGS) $(TEST_FORMAT);
	fi



# //////////////////////////////////////////////////////////////////////////// #
# ///  VALGRIND RULES  /////////////////////////////////////////////////////// #
# //////////////////////////////////////////////////////////////////////////// #

@VALGRIND_CHECK_RULES@ 



# //////////////////////////////////////////////////////////////////////////// #
# ///  FILL TEST CHAIN  ////////////////////////////////////////////////////// #
# //////////////////////////////////////////////////////////////////////////// #

LOG_DRIVER          ?= @LOG_DRIVER@
TESTS_ENVIRONMENT   ?= @TESTS_ENVIRONMENT@
LOG_COMPILER        ?= @LOG_COMPILER@

PY_LOG_COMPILER     ?= $(PYTHON)
PY_LOG_FLAGS        ?= -v
PY_LOG_COMPILER_TAP ?= @PY_LOG_COMPILER_TAP@
PY_LOG_FLAGS_TAP    ?= @PY_LOG_FLAGS_TAP@




# //////////////////////////////////////////////////////////////////////////// #
# ///  TAP TARGET   ////////////////////////////////////////////////////////// #
# //////////////////////////////////////////////////////////////////////////// #

TEST_BUILD_TAP = test-build.tap
TEST_SUITE_TAP = test-suite.tap


.ONESHELL:
$(TEST_BUILD_TAP):
	## Make all recursive targets here without dying.
	$(MAKE) -k $(AM_MAKEFLAGS) clean all \
	CFLAGS="${CFLAGS} -D_TESTING" CPPFLAGS="${CPPFLAGS} -D_TESTING";
	
	## Try to build failed targets one by one
	echo "TAP version 13" > $@;
	count=0;
	for i in $(check_PROGRAMS); do \
	  if ! $(MAKE) -q $$i; then \
	    $(MAKE) -k $(AM_MAKEFLAGS) $$i || \
	    { ((count++)); \
	      echo "not ok $${count} - Build of $${i} failed." >> $@; \
	    }; \
	  fi; \
	done; \
	echo "1..$${count}" >> $@;


.ONESHELL:
$(TEST_SUITE_TAP): $(TEST_BUILD_TAP)
	export TEST_FORMAT="tap";
	
	## run tests	
	$(MAKE) -k $(AM_MAKEFLAGS) $(TEST_LOGS) \
	 PY_LOG_COMPILER=$(PY_LOG_COMPILER_TAP) \
	 PY_LOG_FLAGS="$(PY_LOG_FLAGS_TAP)";
	 
	## collate test-build.tap and 
	perl ${top_srcdir}/testing/collate_tap.pl $(TEST_BUILD_TAP) $(TEST_LOGS) > $@ \
	  || exit 1;


## ////////////////////////////////////////////////////////////////////////// ##
## //  LOG  ///////////////////////////////////////////////////////////////// ##
## ////////////////////////////////////////////////////////////////////////// ##

## TODO: add log output
## $(TEST_SUITE_LOG):


## ////////////////////////////////////////////////////////////////////////// ##
## //  XML  ///////////////////////////////////////////////////////////////// ##
## ////////////////////////////////////////////////////////////////////////// ##

## TODO: add xml output
$(TEST_SUITE_XML):



# //////////////////////////////////////////////////////////////////////////// #
# ///  clean  //////////////////////////////////////////////////////////////// #
# //////////////////////////////////////////////////////////////////////////// #


.PHONY: clean-local-tests
clean-local-tests:
	-$(RM) -rf $(TEST_BUILD_TAP) $(TEST_SUITE_TAP)









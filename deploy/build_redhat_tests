#!/bin/bash

# set -e
# set -o verbose

SCRIPTNAME=$(basename "$0")
SCRIPT_DIR=$(dirname "$0")

SRCDIR=${SRCDIR:=${SCRIPT_DIR}/../}
BUILDDIR=${BUILDDIR:=$(pwd)}
CONFIG_FILE=${CONFIG_FILE:=/usr/local/bin/build_mdsplus.conf}

# evaluate config file
if [ -f ${CONFIG_FILE} ]; then 
 echo "Reading config file: ${CONFIG_FILE}"
 source ${CONFIG_FILE}
fi

print_help() {
cat << EOF

Usage: $SCRIPTNAME [options] [commands]

       options
       -------
       -h|-help|--help)           get this help      
       -c|-config|--config)       set distribution config file
       -b|-builddir|--builddir)   set build directory
       -r|-prefix|--prefix)       set target root directory
       
EOF
}

## parse cmd parameters:
while [[ "$1" == -* ]] ; do
	case "$1" in
		-h|-help|--help)
			print_help
			exit
			;;
		-c|-config|--config)
		        CONFIG_FILE=$2
			shift 2
			;;
		-s|-srcdir|--srcdir)
		        SRCDIR=$2
			shift 2
			;;
		-b|-builddir|--builddir)
			BUILDDIR=$2
			shift 2
			;;
		-p|-prefix|--prefix)
			MDSPLUS_DIR=$2
			shift 2
			;;
		-docker-image|--docker-image)
		        DOKER_IMAGE=$2
			shift 2
			;;
	        -v|-verbose|--verbose)
		        set -o verbose
			shift
			;;
		--)
			#echo "-- found"
			shift
			break
			;;
		*)
		        break
			;;
	esac
done

if [ $# -lt 1 ] ; then
	echo "Incorrect parameters. Use --help for usage instructions."
	exit 1
fi

## get absoulute paths
ABS_SRCDIR=$(cd ${SRCDIR}; pwd)
ABS_BUILDDIR=$(cd ${BUILDDIR}; pwd)

## set commands
CONFIGURE=${ABS_SRCDIR}/configure
MAKE=${MAKE:="env LANG=en_US.UTF-8 make"}

## ensure mdsplusdir is set
MDSPLUS_DIR=${MDSPLUS_DIR:=${ABS_BUILDDIR}}
MDSPLUS_DIR=$(cd ${MDSPLUS_DIR}; pwd)
MDS_PATH=${MDS_PATH:=${ABS_SRCDIR}/tdi}


function install_prefix () {
 [ -d $1 ] || mkdir -p $1
 pushd $1
 # Get the 3rd party software headers etc from github
  wget -q -O - https://github.com/MDSplus/3rd-party-apis/archive/master.tar.gz | (tar zxf -)
 popd
}

# Function to append a string to a indirect expanded variable
function append() { 
eval $1="\"${!1} ${@:2}\""
}


# Function to set configure args from enviroment variables
function set_args() {      

   ## setup configure arguments
   _args_list=''
   
   if [ -n "${DOCKER_IMAGE}" ]; then
    _docker_args="--with-docker-image=${DOCKER_IMAGE}"
    append _args_list "$_docker_args"
   fi

   if [ -n "${DEBUG}" ]; then
    _debug_args="--enable-debug=${DEBUG}"
    append _args_list "$_debug_args"
   fi

   if [ -n "${VALGRIND_LIB}" ]; then
    _valgrind_args="--enable-valgrind"
    append _args_list "$_valgrind_args"
   fi
   
   if [ -n "${JDK_DIR}" ]; then
    _java_args="--with-jdk=${JDK_DIR}"
    append _args_list "$_java_args"
   else
   # TODO: remove this !
    _java_args="--disable-java"
    append _args_list "$_java_args"
   fi
   
   eval $1="\"${_args_list}\""
}



function build_64()  {
  echo /////////////////////////////////////////////////////////////////////////
  echo /// BUILD 64bit  ////////////////////////////////////////////////////////
  echo /////////////////////////////////////////////////////////////////////////

   install_prefix ${MDSPLUS_DIR}   
   set_args _args_list
   echo "ARGS= $_args_list"

   [ -d ${BUILDDIR} ] || mkdir -p ${BUILDDIR}
   pushd ${BUILDDIR}
   ${CONFIGURE} \
            --prefix=${MDSPLUS_DIR} \
            --exec_prefix=${MDSPLUS_DIR}  \
            --bindir=${MDSPLUS_DIR}/bin64 \
            --libdir=${MDSPLUS_DIR}/lib64 \
            --with-idl=${MDSPLUS_DIR}/3rd-party-apis-master/idl \
            --with-labview=${MDSPLUS_DIR}/3rd-party-apis-master/labview \
            --with-gsi=/usr:gcc64 \
            --host=x86-64-linux   \
            --with-java_target=6  \
            --with-java_bootclasspath=${SRCDIR}/rt.jar \
            $_args_list \
            $@;
   
   make clean > /dev/null
   $MAKE
   echo 
   echo " --- MAKING TESTS 64bit --- "
   $MAKE -k tests TEST_FORMAT=tap
   echo 
   echo " --- MAKING TESTS 64bit --- "
   $MAKE -k tests-valgrind TEST_FORMAT=tap

   popd
   exit
};

function build_32()  {
  echo /////////////////////////////////////////////////////////////////////////
  echo /// BUILD 32bit  ////////////////////////////////////////////////////////
  echo /////////////////////////////////////////////////////////////////////////
   
   install_prefix ${MDSPLUS_DIR}   
   set_args _args_list
   echo "ARGS= $_args_list"

   [ -d ${BUILDDIR} ] || mkdir -p ${BUILDDIR}
   pushd ${BUILDDIR}
   ${CONFIGURE} \
            --prefix=${MDSPLUS_DIR} \
            --exec_prefix=${MDSPLUS_DIR}  \
            --bindir=${MDSPLUS_DIR}/bin32 \
            --libdir=${MDSPLUS_DIR}/lib32 \
            --with-idl=${MDSPLUS_DIR}/3rd-party-apis-master/idl \
            --with-labview=${MDSPLUS_DIR}/3rd-party-apis-master/labview \
            --with-gsi=/usr:gcc32 \
            --host=i686-linux     \
            --with-java_target=6  \
            --with-java_bootclasspath=${SRCDIR}/rt.jar \
            $_args_list \
            $@;

   make clean > /dev/null
   $MAKE
   echo 
   echo " --- MAKING TESTS 32bit --- "
   $MAKE -k tests TEST_FORMAT=tap
   echo 
   echo " --- MAKING TESTS 32bit --- "
   $MAKE -k tests-valgrind TEST_FORMAT=tap

   popd
   exit
};




echo ///////////////////////////////////////////////////////////////////////////
echo /// build_redhat_tests ////////////////////////////////////////////////////
echo ///////////////////////////////////////////////////////////////////////////
echo 

eval $1 ${@:2}
exit










